<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh">

<head th:replace="~{layout/head :: head('é ç®—çµæœï½œHappyShop')}"></head>

<body>

<!-- ================= Navbar / Month ================= -->
<div th:replace="~{layout/navbar :: navbar(
    @{/happyshop/result(month=${view.month})}
)}"></div>

<div th:replace="~{layout/month-bar :: monthBar(
    '/happyshop/result',
    ${view.month}
)}"></div>

<div class="container my-4 position-relative">

<!-- ================= éŒ¯èª¤æç¤º ================= -->
<div th:if="${error}"
     class="alert alert-danger auto-close-alert show rounded-4 shadow-sm mb-4"
     style="pointer-events:none;">
  <span th:text="${error}"></span>
</div>

<!-- ================= å°šæœªè¨­å®šåˆ†é¡ ================= -->
<div th:if="${!view.hasAllocation()}" class="text-center py-5">
  <h5 class="fw-bold mb-3">ğŸ“­ å°šæœªè¨­å®šæœ¬æœˆé ç®—åˆ†é…</h5>
  <p class="text-muted mb-4">
    è«‹å…ˆå®Œæˆæœ¬æœˆåˆ†é¡æ¯”ä¾‹è¨­å®šå¾Œï¼Œæ‰èƒ½é–‹å§‹è¨˜å¸³
  </p>
  <a class="btn btn-primary px-4"
     th:href="@{/happyshop/select(month=${view.month})}">
    å‰å¾€è¨­å®šåˆ†é¡
  </a>
</div>

<!-- ================= çµæœé  ================= -->
<div th:if="${view.hasAllocation()}">

<!-- ==================================================
     â­ ç‹€æ…‹ä¸»å¡ç‰‡ï¼ˆä¸å«ä»»ä½•è¡Œç‚ºæŒ‰éˆ•ï¼‰
================================================== -->
<form th:action="@{/income/update(month=${view.month})}"
      method="post"
      class="mb-3">

  <div class="small text-muted mb-1">ğŸ’° æœ¬æœˆè–ªæ°´</div>

  <div class="input-group input-group-sm">
    <input type="number"
           name="income"
           class="form-control"
           min="0"
           th:value="${view.salary}" />

    <button class="btn btn-outline-primary">
      æ›´æ–°
    </button>
  </div>
</form>



  <!-- ğŸ§¯ è¶…é¡æ±  -->
  <div class="border rounded-4 p-3 bg-light mb-3">
    <div class="small text-muted mb-1">ğŸ§¯ æœ¬æœˆæœ€å¤šå¯è¶…é¡ 20%</div>

    <div class="fw-bold">
      å·²ç”¨è¶…é¡ï¼š
      <span class="text-danger"
            th:text="${view.overSpentAmount}">0</span>
      /
      <span th:text="${view.overLimitAmount}">0</span>
    </div>

    <div class="progress mt-2" style="height:10px;">
      <div class="progress-bar bg-danger"
           th:style="'width:' +
             (${view.overLimitAmount} == 0
               ? 0
               : (${view.overSpentAmount} * 100 / ${view.overLimitAmount})) + '%'">
      </div>
    </div>
  </div>

  <!-- ğŸ“Š Month Summary -->
  <div class="row text-center g-2 mb-3">
    <div class="col-6">
      <div class="border rounded-3 py-2 bg-light">
        <div class="small text-muted">ğŸ”¥ å·²ä½¿ç”¨</div>
        <div class="fw-bold"
             th:text="${view.monthlySpentAmount}">0</div>
      </div>
    </div>

    <div class="col-6">
      <div class="border rounded-3 py-2 bg-light">
        <div class="small text-muted">ğŸŸ¢ å‰©é¤˜</div>
        <div class="fw-bold"
             th:text="${view.monthlyRemainingAmount}">0</div>
      </div>
    </div>
  </div>

  <div class="small text-muted"
       th:text="${view.monthlyRuleNote}">
  </div>

</div>

<!-- ==================================================
     ğŸ”½ æ“ä½œåˆ—ï¼ˆè¡Œç‚ºå°ˆå€ï¼Œä¸å†æ“ å£“å¡ç‰‡ï¼‰
================================================== -->
<div class="d-flex justify-content-between align-items-center mb-4">

  <!-- ä¸»è¡Œç‚º -->
  <div>
    <div class="fw-semibold">ğŸ“’ äº¤æ˜“ç´€éŒ„</div>
    <div class="small text-muted">
      æŸ¥çœ‹æœ¬æœˆæ‰€æœ‰æ¶ˆè²»æ˜ç´°èˆ‡ç·¨è¼¯ç´€éŒ„
    </div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-primary btn-sm px-4"
       th:href="@{/happyshop/transactions(month=${view.month})}">
      æŸ¥çœ‹äº¤æ˜“
    </a>

    <button type="button"
            class="btn btn-outline-secondary btn-sm px-3"
            data-bs-toggle="modal"
            data-bs-target="#resetAllocationModal">
      ğŸ”„ é‡æ–°åˆ†é…
    </button>
  </div>
</div>

<!-- ================= Category Cards ================= -->
<div class="row">
  <div class="col-md-6 mb-3"
       th:each="cat : ${view.categorySummaryList}"
       th:if="${cat.allocated or cat.categoryCurrentSpent > 0}">

    <div class="card h-100 shadow-sm border-0 rounded-4 p-3"
         th:classappend="${!cat.allocated} ? 'bg-light disabled-card' : 'cursor-pointer'"
         th:data-category-name="${cat.categoryName}"
         th:data-category-display="${cat.categoryDisplayName}"
         th:data-budget="${cat.effectiveCategoryBudgetAmount}"
         th:data-spent="${cat.categoryCurrentSpent}"
         th:data-bs-toggle="${cat.allocated} ? 'modal' : null"
         th:data-bs-target="${cat.allocated} ? '#addModal' : null">

      <!-- åŸåˆ†é¡å¡å…§å®¹ï¼ˆå®Œå…¨æœªåˆªï¼‰ -->

            <!-- ===== Header ===== -->
      <div class="d-flex justify-content-between mb-1">
        <span class="fw-bold fs-5"
              th:text="${cat.categoryDisplayName}"></span>

        <!-- âœ… æœ‰åˆ†é… -->
        <span class="small text-muted"
              th:if="${cat.allocated}">
          <span th:text="${cat.categoryCurrentSpent}"></span>
          /
          <span th:text="${cat.baseCategoryBudgetAmount}"></span>
          <div class="small text-warning mt-1"
                th:if="${cat.penalizedByOthers}">
                  âš ï¸ å› å…¶ä»–åˆ†é¡è¶…é¡ï¼Œæœ¬åˆ†é¡é ç®—å·²èª¿æ•´
          </div>

        </span>

        <!-- âš ï¸ æœªåˆ†é… -->
        <span class="small text-muted"
              th:if="${!cat.allocated}">
          å°šæœªåˆ†é…
        </span>
      </div>

      <!-- ===== æœ‰åˆ†é…ï¼šåŸæœ¬å®Œæ•´é¡¯ç¤º ===== -->
      <div th:if="${cat.allocated}">

        <div class="small mb-1">
          å‰©é¤˜ï¼š
          <strong th:text="${cat.availableAmount}"></strong>
          <span class="ms-2 text-danger"
                th:if="${cat.categoryOverSpentAmount > 0}">
            è¶…é¡ï¼š
            <strong th:text="${cat.categoryOverSpentAmount}"></strong>
          </span>
        </div>

        <div class="progress" style="height:12px;">
          <div class="progress-bar"
               th:classappend="${cat.displayUsagePercent >= 100}
                 ? 'bg-danger'
                 : (${cat.displayUsagePercent >= 80}
                     ? 'bg-warning'
                     : 'bg-success')"
               th:style="'width:' + ${cat.displayUsagePercent} + '%'">
          </div>
        </div>

        <div class="small text-muted mt-1">
          ä½¿ç”¨ç‡ï¼š
          <strong th:text="${cat.categoryUsagePercent} + '%'"></strong>
        </div>
      </div>

      <!-- ===== æœªåˆ†é…ä½†å·²æ¶ˆè²» ===== -->
      <div th:if="${!cat.allocated}"
           class="mt-2">

        <div class="small text-muted mb-1">
          âš ï¸ æœ¬åˆ†é¡å°šæœªåˆ†é…é ç®—
        </div>

        <div class="fw-bold">
          å·²ç™¼ç”Ÿæ¶ˆè²»ï¼š
          <span th:text="${cat.categoryCurrentSpent}"></span>
        </div>

        <div class="small text-muted mt-1">
          è«‹é‡æ–°åˆ†é…é ç®—ä»¥è¿½è¹¤æ­¤åˆ†é¡ç‹€æ…‹
        </div>
      </div>


    </div>
  </div>
</div>

</div>

<!-- ==================================================
     Modals / Scriptsï¼ˆå®Œå…¨åŸå°ä¸å‹•ï¼‰
================================================== -->

<div class="modal fade" id="addModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
    <div class="modal-content rounded-4">

      <!-- ===== Header ===== -->
      <div class="modal-header border-0">
        <h5 class="fw-bold">â• æ–°å¢æ¶ˆè²»</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form method="post"
            th:action="@{/transaction/add(month=${view.month})}"
            enctype="multipart/form-data">

        <div class="modal-body px-4">

          <p class="text-muted small mb-3">
            è«‹è¼¸å…¥ã€Œé€™ä¸€ç­†å¯¦éš›èŠ±äº†å¤šå°‘éŒ¢ã€ï¼Œç³»çµ±æœƒè‡ªå‹•è¨ˆç®—é ç®—ç‹€æ…‹
          </p>

          <!-- â­ é—œéµï¼šåˆ†é¡è­˜åˆ¥ -->
          <input type="hidden" name="categoryName" id="addCategoryName">

          <!-- æ—¥æœŸ -->
          <div class="mb-3">
            <label class="form-label small text-muted">æ¶ˆè²»æ—¥æœŸ</label>
            <input type="date"
                   class="form-control"
                   name="date"
                   id="addDate"
                   required>
          </div>

          <!-- å³æ™‚é ç®—é¡¯ç¤º -->
          <div class="border rounded-4 p-3 mb-4 bg-light">
            <div class="d-flex justify-content-between mb-1">
              <strong id="addCategoryDisplay">-</strong>
              <span class="text-muted small">
                <span id="addSpent">0</span> /
                <span id="addBudget">0</span>
              </span>
            </div>

            <div class="small mb-1">
              å‰©é¤˜ï¼š<strong id="addRemaining">0</strong>
              <span class="text-danger ms-2" id="addOverWrap" style="display:none;">
                è¶…é¡ï¼š<strong id="addOver">0</strong>
              </span>
              <span class="ms-2">
                ä½¿ç”¨ç‡ï¼š<strong id="addUsage">0%</strong>
              </span>
            </div>

            <div class="progress" style="height:10px;">
              <div class="progress-bar" id="addBar"></div>
            </div>
          </div>

          <!-- é‡‘é¡ -->
          <div class="mb-3">
            <label class="form-label fw-bold">æ¶ˆè²»é‡‘é¡</label>
            <input type="number"
                   class="form-control"
                   id="addAmount"
                   name="amount"
                   min="0"
                   required>
          </div>

          <!-- å‚™è¨» -->
          <div class="mb-3">
            <label class="form-label small text-muted">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
            <textarea class="form-control"
                      name="note"
                      rows="2"></textarea>
          </div>

          <!-- åœ–ç‰‡ -->
          <div class="mb-3">
            <label class="form-label fw-bold">ğŸ“· äº¤æ˜“åœ–ç‰‡ï¼ˆé¸å¡«ï¼‰</label>
            <input type="file"
                   class="form-control"
                   name="image"
                   id="addImage"
                   accept="image/*">
          </div>

          <div id="addImagePreviewWrap" style="display:none;">
            <img id="addImagePreview"
                 class="img-fluid rounded-3 border"
                 style="max-height:200px;">
          </div>

        </div>

        <div class="modal-footer border-0">
          <button class="btn btn-outline-secondary"
                  data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button class="btn btn-primary px-4">å„²å­˜</button>
        </div>

      </form>
    </div>
  </div>
</div>
<!-- ==================================================
     Reset Allocation Modal
================================================== -->
<div class="modal fade" id="resetAllocationModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">

      <div class="modal-header border-0">
        <h5 class="fw-bold">é‡æ–°åˆ†é…æœ¬æœˆé ç®—ï¼Ÿ</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body small text-muted px-4">
        <p class="mb-2">
          ä½ å³å°‡é‡æ–°è¨­å®š <strong th:text="${view.month}"></strong> çš„åˆ†é¡é ç®—ã€‚
        </p>

        <ul class="mb-3">
          <li>âœ… å·²ç¶“ç™¼ç”Ÿçš„æ¶ˆè²»ç´€éŒ„<strong>ä¸æœƒè¢«åˆªé™¤</strong></li>
          <li>âœ… å·²æ¶ˆè²»é‡‘é¡ä»æœƒè¨ˆå…¥çµæœ</li>
          <li>âš ï¸ å¯ç”¨é‡‘é¡<strong>ä¸æœƒå› æ­¤è®Šå¤š</strong></li>
          <li>â„¹ï¸ åªæœƒå½±éŸ¿å¾ŒçºŒçš„é ç®—é…ç½®é¡¯ç¤º</li>
        </ul>

        <p class="mb-0">æ˜¯å¦è¦ç¹¼çºŒï¼Ÿ</p>
      </div>

      <div class="modal-footer border-0">
        <button class="btn btn-outline-secondary"
                data-bs-dismiss="modal">å–æ¶ˆ</button>

        <form method="post"
              th:action="@{/happyshop/month/reset(month=${view.month})}">
          <button class="btn btn-primary px-4">
            ç¢ºèªé‡æ–°åˆ†é…
          </button>
        </form>
      </div>

    </div>
  </div>
</div>

<!-- ==================================================
     Scriptsï¼ˆåŸé‚è¼¯ + åœ–ç‰‡é è¦½ï¼‰
================================================== -->
<script th:inline="javascript">
function applyBar(bar, percent) {
  const p = Math.min(120, Math.max(0, percent));
  bar.style.width = p + '%';
  bar.className =
    'progress-bar ' +
    (percent >= 100 ? 'bg-danger' :
     percent >= 80  ? 'bg-warning' : 'bg-success');
}


const addModal  = document.getElementById('addModal');
const addAmount = document.getElementById('addAmount');
const addDate   = document.getElementById('addDate');
const addImage  = document.getElementById('addImage');

addModal.addEventListener('show.bs.modal', e => {
  const trigger = e.relatedTarget;
  const card = trigger.closest('.card');
  if (!card) return;
  // â­ æ–°å¢ï¼šæœªåˆ†é…åˆ†é¡ä¸å…è¨±é–‹ modalï¼ˆä¿éšªï¼‰
  if (card.classList.contains('disabled-card')) {
    e.preventDefault();
    return;
  }

addModal.dataset.baseBudget = Number(card.dataset.budget || 0);
addModal.dataset.baseSpent  = Number(card.dataset.spent  || 0);

  document.getElementById('addCategoryName').value =
    card.dataset.categoryName || '';

  document.getElementById('addCategoryDisplay').textContent =
    card.dataset.categoryDisplay || '-';

  document.getElementById('addBudget').textContent = addModal.dataset.baseBudget;

  addAmount.value = '';
  updateAddPreview(0);

  // reset image
  addImage.value = '';
  document.getElementById('addImagePreviewWrap').style.display = 'none';

  const ym = /*[[${view.month}]]*/ '2026-01';
  const [y, m] = ym.split('-').map(Number);

  const today = new Date();
  const first = new Date(y, m - 1, 1);
  const last  = new Date(y, m, 0);

  let defaultDate = today;
  if (today < first || today > last) defaultDate = first;

  const fmt = d => {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
};
  addDate.min = fmt(first);
  addDate.max = fmt(last);
  addDate.value = fmt(defaultDate);
});

addAmount.addEventListener('input', () => {
  updateAddPreview(Number(addAmount.value || 0));
});

function updateAddPreview(input) {
  const baseBudget = Number(addModal.dataset.baseBudget || 0);
  const baseSpent  = Number(addModal.dataset.baseSpent  || 0);

  const spent  = baseSpent + input;
  const remain = Math.max(0, baseBudget - spent);
  const usage  =
    baseBudget === 0 ? 0 :
    Math.floor((spent * 100) / baseBudget);

  document.getElementById('addSpent').textContent = spent;
  document.getElementById('addRemaining').textContent = remain;
  document.getElementById('addUsage').textContent = usage + '%';

  const over = Math.max(0, spent - baseBudget);
  document.getElementById('addOver').textContent = over;
  document.getElementById('addOverWrap').style.display =
    over > 0 ? '' : 'none';

  applyBar(document.getElementById('addBar'), usage);
}


/* ===== åœ–ç‰‡å³æ™‚é è¦½ ===== */ 
addImage.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = ev => {
    const img = document.getElementById('addImagePreview');
    img.src = ev.target.result;
    document.getElementById('addImagePreviewWrap').style.display = '';
  };
  reader.readAsDataURL(file);
});
</script>


</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/auto-close-alert.js"></script>

</body>
</html>
