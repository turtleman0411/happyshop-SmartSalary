<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh">

<head th:replace="~{layout/head :: head('HappyShop â€” è®“è–ªæ°´è®Šè°æ˜', 'result.css')}"></head>

<body class="result">

<!-- ================= Navbar / Month ================= -->
<div th:replace="~{layout/navbar :: navbar(@{/happyshop/result(month=${view.month})})}"></div>
<div th:replace="~{layout/month-bar :: monthBar(baseUrl='/happyshop/result', month=${view.month}, themeClass=${themeClass != null ? themeClass : ''})}"></div>


<!-- âœ… åªè®“ Result ä¸»é«”é€²å…¥æˆ‘å€‘çš„ã€ŒèƒŒæ™¯æ¸²æŸ“å®¹å™¨ã€ -->
<main class="hs-result-bg">
  <div class="hs-main-container">

    <!-- ================= éŒ¯èª¤æç¤º ================= -->
    <div th:if="${error}"
         class="alert alert-danger auto-close-alert show rounded-4 shadow-sm mb-3"
         style="pointer-events:none;">
      <span th:text="${error}"></span>
    </div>

<!-- ================= å°šæœªè¨­å®šåˆ†é¡ï¼šEmpty Stateï¼ˆè¦†è“‹ç”¨ï¼‰ ================= -->
<div th:if="${!view.hasAllocation()}" class="hs-empty-wrap">
  <div class="hs-empty-card">

    <div class="hs-empty-icon">ğŸ“­</div>

    <h2 class="hs-empty-title">å°šæœªè¨­å®šæœ¬æœˆé ç®—åˆ†é…</h2>

    <p class="hs-empty-desc">
      å…ˆå®Œæˆæœ¬æœˆã€Œåˆ†é¡æ¯”ä¾‹ã€è¨­å®šå¾Œï¼Œæ‰èƒ½é–‹å§‹è¨˜å¸³ã€‚<br>
      è¨­å®šå®Œæˆå¾Œï¼Œä½ æœƒåœ¨çµæœé çœ‹åˆ°æ¯å€‹åˆ†é¡çš„å‰©é¤˜ã€è¶…é¡èˆ‡é€²åº¦æ¢ã€‚
    </p>

    <div class="hs-empty-actions">
      <a class="btn hs-empty-btn-primary px-4"
         th:href="@{/happyshop/select(month=${view.month})}">
        å‰å¾€è¨­å®šåˆ†é¡
      </a>

      <a class="btn hs-empty-btn-ghost px-4"
         th:href="@{/happyshop/home}">
        å›é¦–é 
      </a>
    </div>

  </div>
</div>



    <!-- ================= æœ‰åˆ†é¡ï¼šçµæœé ä¸»é«” ================= -->
    <div th:if="${view.hasAllocation()}" class="hs-shell">

      <!-- ===== æ“ä½œåˆ— ===== -->
      <div class="hs-panel hs-pad">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">

          <div class="d-flex flex-wrap gap-2">
            <button type="button"
                    class="btn btn-outline-secondary hs-btn"
                    data-bs-toggle="modal"
                    data-bs-target="#resetAllocationModal">
              ğŸ”„ é‡æ–°åˆ†é…
            </button>

            <a class="btn btn-outline-primary hs-btn"
   th:href="@{'/happyshop/transactions?month=' + ${view.month}}">
  æŸ¥çœ‹äº¤æ˜“
</a>
          </div>

          <div class="hs-chip">
            æœ¬æœˆï¼š<strong th:text="${view.month}">2026-01</strong>
          </div>

        </div>
      </div>

      <!-- ===== ä¸Šæ–¹ç¸½è¦½ ===== -->
      <div class="hs-top-grid">

        <!-- æœˆåº¦ç¸½è¦½ -->
        <div class="hs-panel hs-pad">
          <div class="d-flex justify-content-between align-items-start gap-2">
            <div>
              <div class="hs-label">ğŸ’° æœ¬æœˆç¸½è¦½</div>
              <div class="hs-help mt-1" th:text="${view.monthlyRuleNote}"></div>
            </div>

            <div class="hs-chip">
              ä½¿ç”¨ç‡ï¼š<strong th:text="${view.usagePercent + '%'}">0%</strong>
            </div>
          </div>

          <!-- è–ªæ°´æ›´æ–° -->
          <form th:action="@{/income/update}"
                method="post"
                class="mt-3">

            <!-- âœ… month åªç•™åœ¨ body -->
            <input type="hidden" name="month" th:value="${view.month}" />

            <div class="input-group">
              <span class="input-group-text rounded-start-4">è–ªæ°´</span>
              <input type="number"
                    name="income"
                    class="form-control"
                    min="0"
                    th:value="${view.salary}" />
              <button type="submit"
        class="btn btn-outline-primary rounded-end-4 px-3">
  æ›´æ–°
</button>
            </div>
          </form>


          <!-- KPI -->
          <div class="row g-2 mt-3">
            <div class="col-6">
              <div class="hs-kpi">
                <div class="k">æœ¬æœˆç¸½é ç®—</div>
                <div class="v" th:text="${view.monthlyBudgetAmount}">0</div>
              </div>
            </div>

            <div class="col-6">
              <div class="hs-kpi">
                <div class="k">ğŸ”¥ å·²ä½¿ç”¨</div>
                <div class="v" th:text="${view.monthlySpentAmount}">0</div>
              </div>
            </div>

            <div class="col-6">
              <div class="hs-kpi">
                <div class="k">ğŸŸ¢ å‰©é¤˜</div>
                <div class="v" th:text="${view.monthlyRemainingAmount}">0</div>
              </div>
            </div>

            <div class="col-6">
              <div class="hs-kpi">
                <div class="k">å¯é‡æ–°åˆ†é…</div>
                <div class="v" th:text="${view.reallocatableAmount}">0</div>
              </div>
            </div>
          </div>
        </div>

        <!-- è¶…é¡æ±  -->
        <div class="hs-panel hs-pad">
          <div>
            <div class="hs-label">ğŸ§¯ è¶…é¡æ± ï¼ˆä¸Šé™ 20%ï¼‰</div>
            <div class="hs-help mt-1" th:text="${view.overPoolRuleNote}"></div>
          </div>

          <div class="d-flex justify-content-between align-items-end mt-3">
            <div class="fw-bold">
              å·²ç”¨è¶…é¡ï¼š
              <span class="text-danger" th:text="${view.overSpentAmount}">0</span>
              /
              <span th:text="${view.overLimitAmount}">0</span>
            </div>

            <div class="text-muted small">
              å‰©é¤˜ï¼š<strong th:text="${view.overRemainingAmount}">0</strong>
            </div>
          </div>

          <div class="progress hs-progress mt-2">
            <div class="progress-bar bg-danger"
                 th:style="'width:' +
                   (${view.overLimitAmount} == 0
                     ? 0
                     : (${view.overSpentAmount} * 100 / ${view.overLimitAmount})) + '%'">
            </div>
          </div>
        </div>

      </div>

      <!-- ===== åˆ†é¡å€ ===== -->
      <div class="d-flex justify-content-between align-items-end mt-2">
        <div>
          <div class="fw-bold fs-5">ğŸ“¦ æœ¬æœˆåˆ†é¡</div>
          <div class="text-muted small">é»æ“Šåˆ†é¡å¡å¯å¿«é€Ÿæ–°å¢è©²åˆ†é¡æ¶ˆè²»</div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-6"
             th:each="cat : ${view.categorySummaryList}"
             th:if="${cat.allocated or cat.categoryCurrentSpent > 0}">

          <div class="hs-panel hs-pad hs-cat-card"
               th:classappend="${!cat.allocated} ? ' bg-light disabled-card' : ' cat-card'"
               th:data-category-name="${cat.categoryName}"
               th:data-category-display="${cat.categoryDisplayName}"
               th:data-budget="${cat.effectiveCategoryBudgetAmount}"
               th:data-spent="${cat.categoryCurrentSpent}"
               th:data-bs-toggle="${cat.clickableForAddTransaction} ? 'modal' : null"
               th:data-bs-target="${cat.clickableForAddTransaction} ? '#addModal' : null">

            <!-- Header -->
            <div class="d-flex justify-content-between align-items-start gap-2">
              <div class="pe-2" style="min-width:0;">
                <div class="hs-cat-title-wrap">
              <div class="hs-cat-title text-truncate"
                  th:text="${cat.categoryDisplayName}">
              </div>
            </div>


                <!-- âœ… æœ‰ç‹€æ…‹æ‰é¡¯ç¤º -->
                <div class="mt-2" th:if="${cat.hasStateNote()}">
                  <span class="hs-badge"
                        th:classappend="
                          ${cat.state.name() == 'SELF_OVERSPENT'} ? ' is-danger' :
                          (${cat.state.name() == 'GLOBAL_OVERFLOW'} ? ' is-danger' :
                          (${cat.state.name() == 'NO_AVAILABLE_DUE_TO_POOL'} ? ' is-warn' : ''))"
                        th:text="${cat.stateNoteText}">
                  </span>
                </div>
              </div>

              <div class="text-end" style="flex:0 0 auto;">
                <div class="hs-cat-meta" th:if="${cat.allocated}">
                  <span th:text="${cat.categoryCurrentSpent}"></span>
                  <span class="text-muted"> / </span>
                  <span th:text="${cat.baseCategoryBudgetAmount}"></span>
                </div>

                <div class="hs-cat-meta" th:if="${!cat.allocated}">
                  å°šæœªåˆ†é…
                </div>

                <div class="text-muted small mt-1" th:if="${cat.allocated}">
                  é¡¯ç¤ºé ç®—ï¼š<strong th:text="${cat.effectiveCategoryBudgetAmount}">0</strong>
                </div>
              </div>
            </div>

            <!-- Allocated -->
            <div class="mt-3" th:if="${cat.allocated}">
              <div class="hs-cat-kpis">
                <div class="hs-kpi">
                  <div class="k">å‰©é¤˜</div>
                  <div class="v" th:text="${cat.availableAmount}">0</div>
                </div>

                <div class="hs-kpi" th:if="${cat.categoryOverSpentAmount > 0}">
                  <div class="k text-danger">å·²è¶…é¡</div>
                  <div class="v text-danger" th:text="${cat.categoryOverSpentAmount}">0</div>
                </div>

                <div class="hs-kpi" th:if="${cat.categoryOverSpentAmount == 0}">
                  <div class="k">ä½¿ç”¨ç‡</div>
                  <div class="v" th:text="${cat.categoryUsagePercent + '%'}">0%</div>
                </div>
              </div>

              <div class="progress hs-progress mt-3">
                <div class="progress-bar"
                     th:classappend="${cat.progressBarBgClass}"
                     th:style="'width:' + ${cat.displayUsagePercent} + '%'">
                </div>
              </div>

              <div class="hs-cat-foot">
                <span>ä½¿ç”¨ç‡ï¼š<strong th:text="${cat.categoryUsagePercent + '%'}">0%</strong></span>
                <span th:if="${cat.penalizedByOthers}">
                  å› å…¶ä»–åˆ†é¡è¶…é¡ï¼Œæœ¬åˆ†é¡é ç®—å·²èª¿æ•´
                </span>
              </div>
            </div>

            <!-- Not allocated -->
            <div class="mt-3" th:if="${!cat.allocated}">
              <div class="small text-muted mb-2">âš ï¸ æœ¬åˆ†é¡å°šæœªåˆ†é…é ç®—</div>
              <div class="fw-bold">
                å·²ç™¼ç”Ÿæ¶ˆè²»ï¼š<span th:text="${cat.categoryCurrentSpent}"></span>
              </div>
              <div class="small text-muted mt-2">
                å»ºè­°å…ˆã€Œé‡æ–°åˆ†é…ã€ä»¥æ¢å¾©å¯è¿½è¹¤ç‹€æ…‹
              </div>
            </div>

          </div>
        </div>
      </div>

    </div><!-- /hs-shell -->

  </div><!-- /hs-main-container -->
</main>

<!-- ==================================================
     Modals / Scriptsï¼ˆåŸé‚è¼¯ + åœ–ç‰‡é è¦½ï¼‰ä¿ç•™ä½ åŸæœ¬ç‰ˆæœ¬
================================================== -->

<div class="modal fade" id="addModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
    <div class="modal-content rounded-4">

      <div class="modal-header border-0">
        <h5 class="fw-bold">â• æ–°å¢æ¶ˆè²»</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form method="post"
            th:action="@{/happyshop/transaction/add(month=${view.month})}"
            enctype="multipart/form-data">

        <div class="modal-body px-4">

          <p class="text-muted small mb-3">
            è«‹è¼¸å…¥ã€Œé€™ä¸€ç­†å¯¦éš›èŠ±äº†å¤šå°‘éŒ¢ã€ï¼Œç³»çµ±æœƒè‡ªå‹•è¨ˆç®—é ç®—ç‹€æ…‹
          </p>

          <input type="hidden" name="categoryName" id="addCategoryName">

          <div class="mb-3">
            <label class="form-label small text-muted">æ¶ˆè²»æ—¥æœŸ</label>
            <input type="date"
              class="form-control"
              name="date"
              id="addDate"
              required
              th:attr="min=${view.month.atDay(1)}, max=${view.month.atEndOfMonth()}">

          </div>

          <div class="border rounded-4 p-3 mb-4 bg-light">
            <div class="d-flex justify-content-between mb-1">
              <strong id="addCategoryDisplay">-</strong>
              <span class="text-muted small">
                <span id="addSpent">0</span> /
                <span id="addBudget">0</span>
              </span>
            </div>

            <div class="small mb-1">
              å‰©é¤˜ï¼š<strong id="addRemaining">0</strong>
              <span class="text-danger ms-2" id="addOverWrap" style="display:none;">
                è¶…é¡ï¼š<strong id="addOver">0</strong>
              </span>
              <span class="ms-2">
                ä½¿ç”¨ç‡ï¼š<strong id="addUsage">0%</strong>
              </span>
            </div>

            <div class="progress" style="height:10px;">
              <div class="progress-bar" id="addBar"></div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">æ¶ˆè²»é‡‘é¡</label>
            <input type="number"
                   class="form-control"
                   id="addAmount"
                   name="amount"
                   min="0"
                   required>
          </div>

          <div class="mb-3">
            <label class="form-label small text-muted">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
            <textarea class="form-control"
                      name="note"
                      rows="2"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">ğŸ“· äº¤æ˜“åœ–ç‰‡ï¼ˆé¸å¡«ï¼‰</label>
            <input type="file"
                   class="form-control"
                   name="image"
                   id="addImage"
                   accept="image/*">
          </div>

          <div id="addImagePreviewWrap" style="display:none;">
            <img id="addImagePreview"
                 class="img-fluid rounded-3 border"
                 style="max-height:200px;">
          </div>

        </div>

        <div class="modal-footer border-0">
          <button class="btn btn-outline-secondary"
                  data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button class="btn btn-primary px-4">å„²å­˜</button>
        </div>

      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="resetAllocationModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">

      <div class="modal-header border-0">
        <h5 class="fw-bold">é‡æ–°åˆ†é…æœ¬æœˆé ç®—ï¼Ÿ</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body small text-muted px-4">
        <p class="mb-2">
          ä½ å³å°‡é‡æ–°è¨­å®š <strong th:text="${view.month}"></strong> çš„åˆ†é¡é ç®—ã€‚
        </p>

        <ul class="mb-3">
          <li>âœ… å·²ç¶“ç™¼ç”Ÿçš„æ¶ˆè²»ç´€éŒ„<strong>ä¸æœƒè¢«åˆªé™¤</strong></li>
          <li>âœ… å·²æ¶ˆè²»é‡‘é¡ä»æœƒè¨ˆå…¥çµæœ</li>
          <li>âš ï¸ å¯ç”¨é‡‘é¡<strong>ä¸æœƒå› æ­¤è®Šå¤š</strong></li>
          <li>â„¹ï¸ åªæœƒå½±éŸ¿å¾ŒçºŒçš„é ç®—é…ç½®é¡¯ç¤º</li>
        </ul>

        <p class="mb-0">æ˜¯å¦è¦ç¹¼çºŒï¼Ÿ</p>
      </div>

      <div class="modal-footer border-0">
        <button class="btn btn-outline-secondary"
                data-bs-dismiss="modal">å–æ¶ˆ</button>

        <form method="post"
              th:action="@{/happyshop/month/reset(month=${view.month})}">
          <button class="btn btn-primary px-4">
            ç¢ºèªé‡æ–°åˆ†é…
          </button>
        </form>
      </div>

    </div>
  </div>
</div>

<script th:inline="javascript">
function applyBar(bar, percent) {
  const p = Math.min(120, Math.max(0, percent));
  bar.style.width = p + '%';
  bar.className =
    'progress-bar ' +
    (percent >= 100 ? 'bg-danger' :
     percent >= 80  ? 'bg-warning' : 'bg-success');
}

const addModal  = document.getElementById('addModal');
const addAmount = document.getElementById('addAmount');
const addDate   = document.getElementById('addDate');
const addImage  = document.getElementById('addImage');

addModal.addEventListener('show.bs.modal', e => {
  const trigger = e.relatedTarget;

  const card =
    trigger?.closest?.('.cat-card') ||
    trigger?.closest?.('[data-category-name]') ||
    trigger;

  if (!card || !card.dataset || !card.dataset.categoryName) return;

  if (card.classList.contains('disabled-card')) {
    e.preventDefault();
    return;
  }

  const budget = Number(card.dataset.budget || 0);
  const spent  = Number(card.dataset.spent  || 0);

  addModal.dataset.baseBudget = budget;
  addModal.dataset.baseSpent  = spent;

  document.getElementById('addCategoryName').value =
    card.dataset.categoryName || '';

  document.getElementById('addCategoryDisplay').textContent =
    card.dataset.categoryDisplay || '-';

  document.getElementById('addBudget').textContent = budget;

  addAmount.value = '';
  updateAddPreview(0);

  addImage.value = '';
  document.getElementById('addImagePreviewWrap').style.display = 'none';

  // âœ… min/max å·²ç”± HTML(th:attr) è¨­å®šï¼Œé€™è£¡åªæ±ºå®šé è¨­æ—¥æœŸ
  const min = addDate.getAttribute('min');
  const max = addDate.getAttribute('max');

  const today = new Date();
  const todayStr =
    `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

  let v = todayStr;
  if ((min && v < min) || (max && v > max)) v = min || v;
  addDate.value = v;
});


addAmount.addEventListener('input', () => {
  updateAddPreview(Number(addAmount.value || 0));
});

function updateAddPreview(input) {
  const baseBudget = Number(addModal.dataset.baseBudget || 0);
  const baseSpent  = Number(addModal.dataset.baseSpent  || 0);

  const spent  = baseSpent + input;
  const remain = Math.max(0, baseBudget - spent);
  const usage  =
    baseBudget === 0 ? 0 :
    Math.floor((spent * 100) / baseBudget);

  document.getElementById('addSpent').textContent = spent;
  document.getElementById('addRemaining').textContent = remain;
  document.getElementById('addUsage').textContent = usage + '%';

  const over = Math.max(0, spent - baseBudget);
  document.getElementById('addOver').textContent = over;
  document.getElementById('addOverWrap').style.display =
    over > 0 ? '' : 'none';

  applyBar(document.getElementById('addBar'), usage);
}

addImage.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = ev => {
    const img = document.getElementById('addImagePreview');
    img.src = ev.target.result;
    document.getElementById('addImagePreviewWrap').style.display = '';
  };
  reader.readAsDataURL(file);
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


</body>
</html>
