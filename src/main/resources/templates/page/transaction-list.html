<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{layout/head :: head('‰∫§ÊòìÁ¥ÄÈåÑÔΩúHappyShop', 'transaction.css')}"></head>

<body class="transaction">

<!-- ================= Navbar / Month BarÔºàËàá Result ÂÆåÂÖ®‰∏ÄËá¥Ôºâ ================= -->
<div th:replace="~{layout/navbar :: navbar(@{/happyshop/result(month=${view.month})})}"></div>
<div th:replace="~{layout/month-bar :: monthBar(
    baseUrl='/happyshop/result',
    month=${view.month},
    themeClass=${themeClass != null ? themeClass : ''}
)}"></div>

<!-- ================= Result ÂêåÊ¨æËÉåÊôØ‰∏ñÁïå ================= -->
<main class="hs-result-bg">
  <div class="hs-main-container">
    <div class="hs-shell">

      <!-- ================= Êìç‰ΩúÂàó ================= -->
      <div class="hs-panel hs-pad">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">

          <form method="get"
                th:action="@{/happyshop/transactions}"
                class="m-0 d-flex align-items-center gap-2">

            <input type="hidden" name="month" th:value="${view.month}" />

            <select name="category"
                    class="form-select form-select-sm rounded-4"
                    style="min-width:140px;"
                    onchange="this.form.submit()">
              <option value="">ÂÖ®ÈÉ®ÂàÜÈ°û</option>
              <option th:each="opt : ${view.categoryOptions}"
                      th:value="${opt.categoryName}"
                      th:text="${opt.categoryDisplayName}"
                      th:selected="${opt.categoryName == view.selectedCategory}">
              </option>
            </select>
          </form>

          <a class="btn btn-outline-secondary hs-btn"
             th:href="@{/happyshop/result(month=${view.month})}">
            ‚Üê ËøîÂõûÁµêÊûúÈ†Å
          </a>

        </div>
      </div>

      <!-- ================= Ê°åÊ©ü Table ================= -->
      <div class="hs-panel hs-pad d-none d-md-block">

        <div class="table-responsive">
          <table class="table align-middle mb-0">

            <thead class="table-light">
              <tr>
                <th style="width:120px;">Êó•Êúü</th>
                <th style="width:120px;">ÂàÜÈ°û</th>
                <th class="text-end" style="width:120px;">ÈáëÈ°ç</th>
                <th>ÂÇôË®ª</th>
                <th class="text-center" style="width:96px;">ÂúñÁâá</th>
                <th class="text-center" style="width:120px;">Êìç‰Ωú</th>
              </tr>
            </thead>

            <tbody>
              <tr th:if="${#lists.isEmpty(view.transactionList)}">
                <td colspan="6" class="text-center text-muted py-5">
                  Êú¨ÊúàÂ∞öÁÑ°‰∫§ÊòìÁ¥ÄÈåÑ
                </td>
              </tr>

              <tr th:each="tx : ${view.transactionList}">
                <td class="text-body-secondary small" th:text="${tx.date}"></td>
                <td class="fw-semibold" th:text="${tx.categoryDisplayName}"></td>
                <td class="text-end fw-bold" th:text="'$ ' + ${tx.amount}"></td>

                <td>
                  <span class="text-body"
                        th:if="${tx.note != null && !#strings.isEmpty(tx.note)}"
                        th:text="${tx.note}"
                        style="display:inline-block; max-width:520px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                  </span>
                </td>

                <td class="text-center">
                  <img th:if="${tx.imageUrl != null}"
                       th:src="${tx.imageUrl}"
                       class="transaction-thumb"
                       loading="lazy"
                       decoding="async"
                       data-bs-toggle="modal"
                       data-bs-target="#imageModal"
                       th:data-image-url="${tx.imageUrl}">
                  <span th:if="${tx.imageUrl == null}" class="text-body-secondary small"></span>
                </td>

                <!-- ‚úÖ Êìç‰ΩúÔºöÁ∑®ËºØ + Âà™Èô§Ôºàicon ÂêåÈ¢®Ê†ºÔºâ -->
                <td class="text-center">
                  <div class="d-inline-flex align-items-center gap-2">

                    <!-- ‚úèÔ∏è Edit -->
                    <button type="button"
                            class="btn btn-icon-delete js-edit-open"
                            title="‰øÆÊîπ"
                            data-bs-toggle="modal"
                            data-bs-target="#editModal"
                            th:data-transaction-id="${tx.transactionId}"
                            th:data-date="${tx.date}"
                            th:data-category-display="${tx.categoryDisplayName}"
                            th:data-amount="${tx.amount}"
                            th:data-note="${tx.note}"
                            th:data-image-url="${tx.imageUrl}">
                      ‚úèÔ∏è
                    </button>

                    <!-- üóë Delete -->
                    <form th:action="@{/happyshop/transaction/delete}" method="post" class="m-0">
                      <input type="hidden" name="transactionId" th:value="${tx.transactionId}">
                      <input type="hidden" name="month" th:value="${view.month}">
                      <button class="btn btn-icon-delete"
                              title="Âà™Èô§"
                              onclick="return confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠Ü‰∫§ÊòìÂóéÔºü');">
                        üóë
                      </button>
                    </form>

                  </div>
                </td>
              </tr>
            </tbody>

          </table>
        </div>
      </div>

      <!-- ================= ÊâãÊ©ü CardÔºàApple Wallet / SettingsÔºâ ================= -->
      <div class="d-block d-md-none">

        <div th:if="${#lists.isEmpty(view.transactionList)}"
             class="text-center text-muted py-4">
          Êú¨ÊúàÂ∞öÁÑ°‰∫§ÊòìÁ¥ÄÈåÑ
        </div>

        <div th:each="tx : ${view.transactionList}"
             class="hs-panel hs-pad mb-3">

          <div class="d-flex justify-content-between align-items-start gap-3">

            <div class="flex-grow-1" style="min-width:0;">
              <div class="d-flex justify-content-between align-items-start">
                <div class="fw-bold text-truncate"
                     th:text="${tx.categoryDisplayName}">
                </div>
                <div class="fw-bold ms-2"
                     th:text="'$ ' + ${tx.amount}">
                </div>
              </div>

              <div class="small text-body-secondary mt-1"
                   th:text="${tx.date}">
              </div>

              <div class="mt-2 text-body"
                   th:if="${tx.note != null && !#strings.isEmpty(tx.note)}"
                   th:text="${tx.note}"
                   style="display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">
              </div>
            </div>

            <div class="thumb-slot-right"
                 th:style="${tx.imageUrl == null} ? 'background:transparent;' : null">
              <img th:if="${tx.imageUrl != null}"
                   th:src="${tx.imageUrl}"
                   class="transaction-thumb"
                   loading="lazy"
                   decoding="async"
                   data-bs-toggle="modal"
                   data-bs-target="#imageModal"
                   th:data-image-url="${tx.imageUrl}">
            </div>

          </div>

          <!-- ‚úÖ ÊâãÊ©üÊìç‰ΩúÔºöÁ∑®ËºØ + Âà™Èô§ -->
          <div class="d-flex justify-content-end mt-2 gap-2">

            <button type="button"
                    class="btn btn-icon-delete js-edit-open"
                    title="‰øÆÊîπ"
                    data-bs-toggle="modal"
                    data-bs-target="#editModal"
                    th:data-transaction-id="${tx.transactionId}"
                    th:data-date="${tx.date}"
                    th:data-category-display="${tx.categoryDisplayName}"
                    th:data-amount="${tx.amount}"
                    th:data-note="${tx.note}"
                    th:data-image-url="${tx.imageUrl}">
              ‚úèÔ∏è
            </button>

            <form th:action="@{/happyshop/transaction/delete}" method="post" class="m-0">
              <input type="hidden" name="transactionId" th:value="${tx.transactionId}">
              <input type="hidden" name="month" th:value="${view.month}">
              <button class="btn btn-icon-delete"
                      title="Âà™Èô§"
                      onclick="return confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠Ü‰∫§ÊòìÂóéÔºü');">
                üóë
              </button>
            </form>

          </div>

        </div>
      </div>

    </div>
  </div>
</main>

<!-- ‚úÖ Edit ModalÔºöÁî® fragment ÂºïÂÖ•ÔºàÂè™Êîæ‰∏ÄÊ¨°Ôºâ -->
<div th:replace="~{fragment/transaction-edit-modal :: editTransactionModal}"></div>

<!-- ================= Image Modal ================= -->
<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
    <div class="modal-content bg-dark border-0 position-relative">
      <button class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
              data-bs-dismiss="modal"></button>

      <img id="modalImage"
           class="w-100"
           style="object-fit:contain; max-height:90vh; cursor:zoom-out;"
           data-bs-dismiss="modal">
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/transaction-edit.js" defer></script>

</body>
</html>
