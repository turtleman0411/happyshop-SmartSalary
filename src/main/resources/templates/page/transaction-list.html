<!DOCTYPE html>

<html lang="zh" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{layout/head :: head('HappyShop — 讓薪水變聰明', 'home.css')}"></head>


<body class="transaction">

<!-- ================= Navbar ================= -->

<div th:replace="~{layout/navbar :: navbar(@{/happyshop/result(month=${view.month})})}"></div>
<!-- ================= Month Bar ================= -->

<div th:replace="~{layout/month-bar :: monthBar(baseUrl='/happyshop/result', month=${view.month}, themeClass=${themeClass != null ? themeClass : ''})}"></div>
<div class="container my-4 page-card">


<!-- ===== 標題 ===== -->
<div class="mb-4 d-flex justify-content-between align-items-center">




    <!-- 操作區 -->
    <div class="d-flex align-items-center gap-2">

        <!-- 🔽 分類下拉（自動送出） -->
        <form method="get"
              th:action="@{/happyshop/transactions}"
              class="m-0">

            <input type="hidden" name="month"
                   th:value="${view.month}" />

            <select name="category"
                    class="form-select form-select-sm rounded-4"
                    style="min-width: 140px;"
                    onchange="this.form.submit()">

                <option value="">全部分類</option>

                <option th:each="opt : ${view.categoryOptions}"
                        th:value="${opt.categoryName}"
                        th:text="${opt.categoryDisplayName}"
                        th:selected="${opt.categoryName == view.selectedCategory}">
                </option>
            </select>
        </form>

        <!-- 返回 -->
        <a class="btn btn-outline-secondary btn-sm rounded-4"
           th:href="@{/happyshop/result(month=${view.month})}">
            ← 返回
        </a>
    </div>
</div>


<!-- ================= 桌機 Table（升級排版） ================= -->
<div class="d-none d-md-block">

  <div class="card border-0 rounded-4 shadow-sm overflow-hidden">
    <div class="table-responsive">
      <table class="table align-middle mb-0">

        <thead class="table-light">
        <tr>
          <th style="width:130px;">日期</th>
          <th style="width:120px;">分類</th>
          <th class="text-end" style="width:120px;">金額</th>
          <th>備註</th>
          <th class="text-center" style="width:96px;">圖片</th>
          <th class="text-center" style="width:110px;">操作</th>
        </tr>
        </thead>

        <tbody>
        <tr th:if="${#lists.isEmpty(view.transactionList)}">
          <td colspan="6" class="text-center text-muted py-5">
            本月尚無交易紀錄
          </td>
        </tr>

        <tr th:each="tx : ${view.transactionList}">
          <!-- 日期：小字、穩定寬度 -->
          <td class="text-body-secondary small" th:text="${tx.date}"></td>

          <!-- 分類：粗體突出 -->
          <td class="fw-semibold" th:text="${tx.categoryDisplayName}"></td>

          <!-- 金額：右對齊、加強可掃描 -->
          <td class="text-end fw-bold" th:text="'$ ' + ${tx.amount}"></td>

          <!-- 備註：空值顯示 —，長字截斷不撐版 -->
          <td>
            <span class="text-body"
                  th:text="${tx.note != null && !#strings.isEmpty(tx.note) ? tx.note : '—'}"
                  style="display:inline-block; max-width: 520px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
            </span>
          </td>

          <!-- 圖片：縮圖 + 點擊放大（你既有的 modal） -->
          <td class="text-center">
            <img th:if="${tx.imageUrl != null}"
                 th:src="${tx.imageUrl}"
                 class="transaction-thumb"
                 loading="lazy"
                 decoding="async"
                 data-bs-toggle="modal"
                 data-bs-target="#imageModal"
                 th:data-image-url="${tx.imageUrl}">
            <span th:if="${tx.imageUrl == null}" class="text-body-secondary small">—</span>
          </td>

          <!-- 操作：按鈕一致、點擊區穩定 -->
          <td class="text-center">
            <form th:action="@{/transaction/delete}"
                  method="post"
                  class="m-0 d-inline">
              <input type="hidden" name="transactionId" th:value="${tx.transactionId}">
              <input type="hidden" name="month" th:value="${view.month}">
              <button type="submit"
                      class="btn btn-sm btn-outline-danger rounded-4 px-3"
                      onclick="return confirm('確定要刪除這筆交易嗎？');">
                🗑 刪除
              </button>
            </form>
          </td>
        </tr>
        </tbody>

      </table>
    </div>
  </div>

</div>

<!-- ================= 手機 Card（優化版：圖右字左＋更緊湊） ================= -->
<div class="d-block d-md-none">

    <div th:if="${#lists.isEmpty(view.transactionList)}"
         class="text-center text-muted py-4">
        本月尚無交易紀錄
    </div>

    <div th:each="tx : ${view.transactionList}"
         class="card shadow-sm border-0 rounded-4 p-3 mb-3">

        <!-- 上：文字（左） + 固定縮圖槽位（右） -->
        <div class="d-flex justify-content-between align-items-start gap-3">

            <!-- 左：文字區（永遠貼左，不會被圖片擠） -->
            <div class="flex-grow-1" style="min-width:0;">

                <div class="d-flex justify-content-between align-items-start">
                    <div class="fw-bold text-truncate"
                         th:text="${tx.categoryDisplayName}">
                    </div>

                    <div class="fw-bold ms-2"
                         th:text="'$ ' + ${tx.amount}">
                    </div>
                </div>

                <div class="small text-body-secondary mt-1"
                     th:text="${tx.date}">
                </div>

                <!-- 備註：空白就不顯示，最多 2 行 -->
                <div class="mt-2 text-body"
                     th:if="${tx.note != null && !#strings.isEmpty(tx.note)}"
                     th:text="${tx.note}"
                     style="display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">
                </div>

            </div>

            <!-- 右：固定縮圖槽位（永遠存在，有圖才塞 img） -->
            <div class="thumb-slot-right"
                 th:style="${tx.imageUrl == null} ? 'background:transparent;' : null">

                <img th:if="${tx.imageUrl != null}"
                     th:src="${tx.imageUrl}"
                     class="transaction-thumb"
                     loading="lazy"
                     decoding="async"
                     data-bs-toggle="modal"
                     data-bs-target="#imageModal"
                     th:data-image-url="${tx.imageUrl}">
            </div>

        </div>

        <!-- 下：操作列（更省空間版，按鈕縮小） -->
        <div class="d-flex justify-content-end mt-2">
            <form th:action="@{/transaction/delete}"
                  method="post"
                  class="m-0">
                <input type="hidden" name="transactionId" th:value="${tx.transactionId}">
                <input type="hidden" name="month" th:value="${view.month}">
                <button type="submit"
                        class="btn btn-sm btn-outline-danger rounded-4 px-3"
                        onclick="return confirm('確定要刪除這筆交易嗎？');">
                    🗑 刪除
                </button>
            </form>
        </div>

    </div>
</div>

<!-- =============== Image Modal (共用) =============== -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
    <div class="modal-content bg-dark border-0 position-relative">

      <!-- 右上角關閉 -->
      <button type="button"
              class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
              data-bs-dismiss="modal"
              aria-label="Close"></button>

      <!-- 圖片：點一下也關閉 -->
      <img id="modalImage"
           class="w-100"
           style="object-fit: contain; max-height: 90vh; cursor: zoom-out;"
           data-bs-dismiss="modal">
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.querySelectorAll('.transaction-thumb').forEach(img => {
    img.addEventListener('click', () => {
        document.getElementById('modalImage').src =
            img.dataset.imageUrl;
    });
});
</script>

</body>
</html>
